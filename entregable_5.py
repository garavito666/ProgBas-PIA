# -*- coding: utf-8 -*-
"""Entregable_5

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1CXTcRcrq_uuollYJ9f957qg1t0_U4kjS

# **Entregable 5**
**üîß Resumen de mejoras al c√≥digo:**

**Documentaci√≥n clara:**
Se agregaron docstrings a todas las funciones para explicar qu√© hacen, qu√© par√°metros reciben y qu√© devuelven.

**Manejo de errores mejorado:**
Se a√±adieron verificaciones para evitar que el programa falle si hay errores en la conexi√≥n a la API o si los datos del CSV son inv√°lidos.

**Validaci√≥n de datos:**
Antes de analizar o graficar, se revisa que los datos est√©n completos y bien formateados (por ejemplo, que los n√∫meros sean v√°lidos).

**C√≥digo m√°s limpio y organizado:**
Se reordenaron funciones, se eliminaron repeticiones y se usaron nombres m√°s descriptivos para que el c√≥digo sea m√°s f√°cil de entender y mantener.

**Mensajes claros para el usuario:**
Se mejoraron los mensajes en consola para que sean m√°s amigables y ayuden a entender qu√© est√° ocurriendo o si algo sale mal.
"""

!pip install requests
!pip install plotext
!pip install openpyxl

import requests
import csv
import json
from datetime import datetime
import statistics
import plotext as plt
from openpyxl import Workbook

API_KEY = "f0f0c07c117721896152aeca0fbbe31a"

def get_weather_current(city):
    """
    Consulta el clima actual de una ciudad desde la API de OpenWeather.

    Args:
        city (str): Nombre de la ciudad.

    Returns:
        dict or None: Diccionario con informaci√≥n del clima actual o None si falla la solicitud.
    """
    try:
        url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={API_KEY}&units=metric"
        res = requests.get(url)
        if res.status_code != 200:
            print(f"‚ùå Error: Ciudad '{city}' no encontrada o API fall√≥.")
            return None
        data = res.json()
        return {
            "fecha": datetime.utcfromtimestamp(data["dt"]).strftime("%Y-%m-%d"),
            "ciudad": data["name"],
            "temperatura": data["main"]["temp"],
            "humedad": data["main"]["humidity"],
            "presion": data["main"]["pressure"],
            "tipo": "actual"
        }
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error de red al consultar el clima: {e}")
        return None

def get_weather_forecast(city):
    """
    Consulta el pron√≥stico del clima a 5 d√≠as desde la API de OpenWeather.

    Args:
        city (str): Nombre de la ciudad.

    Returns:
        list: Lista de diccionarios con pron√≥sticos diarios a las 18:00.
    """
    try:
        url = f"https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={API_KEY}&units=metric"
        res = requests.get(url)
        if res.status_code != 200:
            print(f"‚ùå Error: Ciudad '{city}' no encontrada o API fall√≥.")
            return []
        data = res.json()
        forecast_data = []
        for item in data["list"]:
            if item["dt_txt"].endswith("18:00:00"):
                forecast_data.append({
                    "fecha": item["dt_txt"].split()[0],
                    "ciudad": data["city"]["name"],
                    "temperatura": item["main"]["temp"],
                    "humedad": item["main"]["humidity"],
                    "presion": item["main"]["pressure"],
                    "tipo": "pronostico"
                })
        return forecast_data
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error de red al obtener el pron√≥stico: {e}")
        return []

def guardar_csv(datos, nombre_archivo):
    """
    Guarda datos en un archivo CSV.

    Args:
        datos (list): Lista de diccionarios con datos clim√°ticos.
        nombre_archivo (str): Nombre del archivo CSV.
    """
    campos = ["fecha", "ciudad", "temperatura", "humedad", "presion", "tipo"]
    with open(nombre_archivo, mode='w', encoding='utf-8', newline='') as archivo:
        escritor = csv.DictWriter(archivo, fieldnames=campos)
        escritor.writeheader()
        escritor.writerows(datos)

def guardar_json(datos, nombre_archivo):
    """
    Guarda datos en un archivo JSON.

    Args:
        datos (list): Lista de diccionarios.
        nombre_archivo (str): Nombre del archivo JSON.
    """
    with open(nombre_archivo, mode='w', encoding='utf-8') as archivo:
        json.dump(datos, archivo, indent=4, ensure_ascii=False)

def guardar_excel(datos, nombre_archivo):
    """
    Guarda datos en un archivo Excel (.xlsx).

    Args:
        datos (list): Lista de diccionarios.
        nombre_archivo (str): Nombre del archivo Excel.
    """
    wb = Workbook()
    ws = wb.active
    ws.title = "Datos Clima"
    ws.append(["Fecha", "Ciudad", "Temperatura (¬∞C)", "Humedad (%)", "Presi√≥n (hPa)", "Tipo"])
    for d in datos:
        ws.append([d["fecha"], d["ciudad"], d["temperatura"], d["humedad"], d["presion"], d["tipo"]])
    wb.save(nombre_archivo)

def leer_datos_csv(nombre_archivo):
    """
    Lee un archivo CSV y devuelve una lista de diccionarios con los datos.

    Args:
        nombre_archivo (str): Ruta al archivo CSV.

    Returns:
        list: Lista de diccionarios con datos validados.
    """
    datos = []
    try:
        with open(nombre_archivo, mode='r', encoding='utf-8') as archivo:
            lector = csv.DictReader(archivo)
            for fila in lector:
                try:
                    datos.append({
                        "fecha": fila["fecha"],
                        "ciudad": fila["ciudad"],
                        "temperatura": float(fila["temperatura"]),
                        "humedad": float(fila["humedad"]),
                        "presion": float(fila["presion"]),
                        "tipo": fila["tipo"]
                    })
                except ValueError:
                    print(f"‚ö†Ô∏è Datos inv√°lidos en fila: {fila}")
    except FileNotFoundError:
        print(f"‚ùå Archivo CSV no encontrado: {nombre_archivo}")
    except Exception as e:
        print(f"‚ùå Error leyendo CSV: {e}")
    return datos

def analizar_datos(datos):
    """
    Realiza un an√°lisis estad√≠stico b√°sico de los datos clim√°ticos.

    Args:
        datos (list): Lista de diccionarios con datos.
    """
    if not datos:
        print("‚ö†Ô∏è No hay datos para analizar.")
        return

    # Validaci√≥n adicional: eliminar entradas con datos faltantes
    datos = [d for d in datos if all(isinstance(d[k], (int, float)) for k in ["temperatura", "humedad", "presion"])]
    if not datos:
        print("‚ö†Ô∏è Todos los datos eran inv√°lidos o incompletos.")
        return

    temperaturas = [d["temperatura"] for d in datos]
    humedades = [d["humedad"] for d in datos]
    presiones = [d["presion"] for d in datos]

    print("\nüìà Resultados del an√°lisis:")
    print(f"üå°Ô∏è Temperatura promedio: {statistics.mean(temperaturas):.2f} ¬∞C")
    if len(temperaturas) > 1:
        print(f"üìâ Desviaci√≥n est√°ndar de la temperatura: {statistics.stdev(temperaturas):.2f} ¬∞C")
    else:
        print("‚ö†Ô∏è No hay suficientes datos para calcular la desviaci√≥n est√°ndar.")
    print(f"üíß Humedad promedio: {statistics.mean(humedades):.2f} %")
    print(f"üß≠ Rango de presi√≥n atmosf√©rica: {min(presiones):.2f} - {max(presiones):.2f} hPa")
    print(f"üèôÔ∏è Ciudades analizadas: {', '.join(set(d['ciudad'] for d in datos))}")
    print(f"üìÖ D√≠as analizados: {', '.join(set(d['fecha'] for d in datos))}")

def graficar_lineas(datos):
    """
    Genera un gr√°fico de l√≠nea de la temperatura promedio por d√≠a.
    """
    fechas = sorted(set(d["fecha"] for d in datos))
    fechas_convertidas = [datetime.strptime(f, "%Y-%m-%d").strftime("%d/%m/%Y") for f in fechas]
    temperaturas = [sum(d["temperatura"] for d in datos if d["fecha"] == f) / len([d for d in datos if d["fecha"] == f]) for f in fechas]

    plt.clear_figure()
    plt.title("üå°Ô∏è Temperatura promedio diaria")
    plt.plot(fechas_convertidas, temperaturas, marker='dot')
    plt.xlabel("Fecha (DD/MM/YYYY)")
    plt.ylabel("Temperatura (¬∞C)")
    plt.grid(True)
    plt.show()

def graficar_barras(datos):
    """
    Genera un gr√°fico de barras de la humedad promedio por d√≠a.
    """
    fechas = sorted(set(d["fecha"] for d in datos))
    fechas_convertidas = [datetime.strptime(f, "%Y-%m-%d").strftime("%d/%m/%Y") for f in fechas]
    humedades = [sum(d["humedad"] for d in datos if d["fecha"] == f) / len([d for d in datos if d["fecha"] == f]) for f in fechas]

    plt.clear_figure()
    plt.title("üíß Humedad promedio diaria")
    plt.bar(fechas_convertidas, humedades, color="cyan")
    plt.xlabel("Fecha (DD/MM/YYYY)")
    plt.ylabel("Humedad (%)")
    plt.grid(True)
    plt.show()

def graficar_dispersion(datos):
    """
    Muestra un gr√°fico de dispersi√≥n entre temperatura y presi√≥n.
    """
    temperaturas = [d["temperatura"] for d in datos]
    presiones = [d["presion"] for d in datos]

    plt.clear_figure()
    plt.title("üß≠ Presi√≥n vs Temperatura")
    plt.scatter(temperaturas, presiones)
    plt.xlabel("Temperatura (¬∞C)")
    plt.ylabel("Presi√≥n (hPa)")
    plt.grid(True)
    plt.show()

def menu_graficas(datos):
    """
    Men√∫ interactivo para seleccionar y mostrar gr√°ficos.
    """
    while True:
        print("\nüìä Elige una opci√≥n para visualizar:")
        print("1. Gr√°fico de l√≠neas (Temperatura)")
        print("2. Gr√°fico de barras (Humedad)")
        print("3. Diagrama de dispersi√≥n (Presi√≥n vs Temperatura)")
        print("4. Ver todas")
        print("5. Salir")

        opcion = input("üëâ Tu elecci√≥n: ").strip()
        if opcion == "1":
            graficar_lineas(datos)
        elif opcion == "2":
            graficar_barras(datos)
        elif opcion == "3":
            graficar_dispersion(datos)
        elif opcion == "4":
            graficar_lineas(datos)
            graficar_barras(datos)
            graficar_dispersion(datos)
        elif opcion == "5":
            break
        else:
            print("‚ö†Ô∏è Opci√≥n inv√°lida. Intenta de nuevo.")

def mostrar_datos(actual, pronostico):
    """
    Imprime en consola los datos clim√°ticos actuales y del pron√≥stico.

    Args:
        actual (dict): Datos actuales.
        pronostico (list): Lista de datos del pron√≥stico.
    """
    print(f"\nüåÜ Clima actual en {actual['ciudad']} ({actual['fecha']}):")
    print(f"  Temperatura: {actual['temperatura']} ¬∞C")
    print(f"  Humedad: {actual['humedad']} %")
    print(f"  Presi√≥n: {actual['presion']} hPa")
    print("\nüìÖ Pron√≥stico a 5 d√≠as (18:00 hrs):")
    for p in pronostico:
        print(f"  {p['fecha']} -> Temp: {p['temperatura']} ¬∞C, Humedad: {p['humedad']} %, Presi√≥n: {p['presion']} hPa")

def main():
    """
    Funci√≥n principal que coordina el flujo completo del programa.
    """
    ciudad = input("üåÜ Ingrese la ciudad para consultar el clima: ").strip()
    if not ciudad:
        print("‚ùå No ingres√≥ ninguna ciudad.")
        return

    actual = get_weather_current(ciudad)
    if actual is None:
        return

    pronostico = get_weather_forecast(ciudad)
    mostrar_datos(actual, pronostico)

    datos_guardar = [actual] + pronostico
    guardar_csv(datos_guardar, "clima_datos.csv")
    guardar_json(datos_guardar, "clima_datos.json")
    guardar_excel(datos_guardar, "clima_datos.xlsx")

    print("\n‚úÖ Datos guardados en 'clima_datos.csv', 'clima_datos.json' y 'clima_datos.xlsx'")

    datos_csv = leer_datos_csv("clima_datos.csv")
    print("\n--- An√°lisis basado en CSV ---")
    analizar_datos(datos_csv)
    menu_graficas(datos_csv)

if __name__ == "__main__":
    main()

"""Los datos se guardan correctamente en documentos .csv y .json as√≠ como en una tabla ordenada en una hoja de excel de maneta autom√°tica."""