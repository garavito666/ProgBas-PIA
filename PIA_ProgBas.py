# -*- coding: utf-8 -*-
"""PIA-ProgBas

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pCXCY7_M17ja4rPIlPRgMbZyUPHA40-2
"""

!pip install requests
!pip install plotext
!pip install openpyxl

import requests
import csv
import json
from datetime import datetime
import statistics
import plotext as plt
from openpyxl import Workbook

API_KEY = "f0f0c07c117721896152aeca0fbbe31a"

def get_weather_current(city):
    """
    Consulta el clima actual de una ciudad desde la API de OpenWeather.

    Args:
        city (str): Nombre de la ciudad.

    Returns:
        dict or None: Diccionario con informaciÃ³n del clima actual o None si falla la solicitud.
    """
    try:
        url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={API_KEY}&units=metric"
        res = requests.get(url)
        if res.status_code != 200:
            print(f"âŒ Error: Ciudad '{city}' no encontrada o API fallÃ³.")
            return None
        data = res.json()
        return {
            "fecha": datetime.utcfromtimestamp(data["dt"]).strftime("%Y-%m-%d"),
            "ciudad": data["name"],
            "temperatura": data["main"]["temp"],
            "humedad": data["main"]["humidity"],
            "presion": data["main"]["pressure"],
            "tipo": "actual"
        }
    except requests.exceptions.RequestException as e:
        print(f"âŒ Error de red al consultar el clima: {e}")
        return None

def get_weather_forecast(city):
    """
    Consulta el pronÃ³stico del clima a 5 dÃ­as desde la API de OpenWeather.

    Args:
        city (str): Nombre de la ciudad.

    Returns:
        list: Lista de diccionarios con pronÃ³sticos diarios a las 18:00.
    """
    try:
        url = f"https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={API_KEY}&units=metric"
        res = requests.get(url)
        if res.status_code != 200:
            print(f"âŒ Error: Ciudad '{city}' no encontrada o API fallÃ³.")
            return []
        data = res.json()
        forecast_data = []
        for item in data["list"]:
            if item["dt_txt"].endswith("18:00:00"):
                forecast_data.append({
                    "fecha": item["dt_txt"].split()[0],
                    "ciudad": data["city"]["name"],
                    "temperatura": item["main"]["temp"],
                    "humedad": item["main"]["humidity"],
                    "presion": item["main"]["pressure"],
                    "tipo": "pronostico"
                })
        return forecast_data
    except requests.exceptions.RequestException as e:
        print(f"âŒ Error de red al obtener el pronÃ³stico: {e}")
        return []

def guardar_csv(datos, nombre_archivo):
    """
    Guarda datos en un archivo CSV.

    Args:
        datos (list): Lista de diccionarios con datos climÃ¡ticos.
        nombre_archivo (str): Nombre del archivo CSV.
    """
    campos = ["fecha", "ciudad", "temperatura", "humedad", "presion", "tipo"]
    with open(nombre_archivo, mode='w', encoding='utf-8', newline='') as archivo:
        escritor = csv.DictWriter(archivo, fieldnames=campos)
        escritor.writeheader()
        escritor.writerows(datos)

def guardar_json(datos, nombre_archivo):
    """
    Guarda datos en un archivo JSON.

    Args:
        datos (list): Lista de diccionarios.
        nombre_archivo (str): Nombre del archivo JSON.
    """
    with open(nombre_archivo, mode='w', encoding='utf-8') as archivo:
        json.dump(datos, archivo, indent=4, ensure_ascii=False)

def guardar_excel(datos, nombre_archivo):
    """
    Guarda datos en un archivo Excel (.xlsx).

    Args:
        datos (list): Lista de diccionarios.
        nombre_archivo (str): Nombre del archivo Excel.
    """
    wb = Workbook()
    ws = wb.active
    ws.title = "Datos Clima"
    ws.append(["Fecha", "Ciudad", "Temperatura (Â°C)", "Humedad (%)", "PresiÃ³n (hPa)", "Tipo"])
    for d in datos:
        ws.append([d["fecha"], d["ciudad"], d["temperatura"], d["humedad"], d["presion"], d["tipo"]])
    wb.save(nombre_archivo)

def leer_datos_csv(nombre_archivo):
    """
    Lee un archivo CSV y devuelve una lista de diccionarios con los datos.

    Args:
        nombre_archivo (str): Ruta al archivo CSV.

    Returns:
        list: Lista de diccionarios con datos validados.
    """
    datos = []
    try:
        with open(nombre_archivo, mode='r', encoding='utf-8') as archivo:
            lector = csv.DictReader(archivo)
            for fila in lector:
                try:
                    datos.append({
                        "fecha": fila["fecha"],
                        "ciudad": fila["ciudad"],
                        "temperatura": float(fila["temperatura"]),
                        "humedad": float(fila["humedad"]),
                        "presion": float(fila["presion"]),
                        "tipo": fila["tipo"]
                    })
                except ValueError:
                    print(f"âš ï¸ Datos invÃ¡lidos en fila: {fila}")
    except FileNotFoundError:
        print(f"âŒ Archivo CSV no encontrado: {nombre_archivo}")
    except Exception as e:
        print(f"âŒ Error leyendo CSV: {e}")
    return datos

def analizar_datos(datos):
    """
    Realiza un anÃ¡lisis estadÃ­stico bÃ¡sico de los datos climÃ¡ticos.

    Args:
        datos (list): Lista de diccionarios con datos.
    """
    if not datos:
        print("âš ï¸ No hay datos para analizar.")
        return

    # ValidaciÃ³n adicional: eliminar entradas con datos faltantes
    datos = [d for d in datos if all(isinstance(d[k], (int, float)) for k in ["temperatura", "humedad", "presion"])]
    if not datos:
        print("âš ï¸ Todos los datos eran invÃ¡lidos o incompletos.")
        return

    temperaturas = [d["temperatura"] for d in datos]
    humedades = [d["humedad"] for d in datos]
    presiones = [d["presion"] for d in datos]

    print("\nğŸ“ˆ Resultados del anÃ¡lisis:")
    print(f"ğŸŒ¡ï¸ Temperatura promedio: {statistics.mean(temperaturas):.2f} Â°C")
    if len(temperaturas) > 1:
        print(f"ğŸ“‰ DesviaciÃ³n estÃ¡ndar de la temperatura: {statistics.stdev(temperaturas):.2f} Â°C")
    else:
        print("âš ï¸ No hay suficientes datos para calcular la desviaciÃ³n estÃ¡ndar.")
    print(f"ğŸ’§ Humedad promedio: {statistics.mean(humedades):.2f} %")
    print(f"ğŸ§­ Rango de presiÃ³n atmosfÃ©rica: {min(presiones):.2f} - {max(presiones):.2f} hPa")
    print(f"ğŸ™ï¸ Ciudades analizadas: {', '.join(set(d['ciudad'] for d in datos))}")
    print(f"ğŸ“… DÃ­as analizados: {', '.join(set(d['fecha'] for d in datos))}")

def graficar_lineas(datos):
    """
    Genera un grÃ¡fico de lÃ­nea de la temperatura promedio por dÃ­a.
    """
    fechas = sorted(set(d["fecha"] for d in datos))
    fechas_convertidas = [datetime.strptime(f, "%Y-%m-%d").strftime("%d/%m/%Y") for f in fechas]
    temperaturas = [sum(d["temperatura"] for d in datos if d["fecha"] == f) / len([d for d in datos if d["fecha"] == f]) for f in fechas]

    plt.clear_figure()
    plt.title("ğŸŒ¡ï¸ Temperatura promedio diaria")
    plt.plot(fechas_convertidas, temperaturas, marker='dot')
    plt.xlabel("Fecha (DD/MM/YYYY)")
    plt.ylabel("Temperatura (Â°C)")
    plt.grid(True)
    plt.show()

def graficar_barras(datos):
    """
    Genera un grÃ¡fico de barras de la humedad promedio por dÃ­a.
    """
    fechas = sorted(set(d["fecha"] for d in datos))
    fechas_convertidas = [datetime.strptime(f, "%Y-%m-%d").strftime("%d/%m/%Y") for f in fechas]
    humedades = [sum(d["humedad"] for d in datos if d["fecha"] == f) / len([d for d in datos if d["fecha"] == f]) for f in fechas]

    plt.clear_figure()
    plt.title("ğŸ’§ Humedad promedio diaria")
    plt.bar(fechas_convertidas, humedades, color="cyan")
    plt.xlabel("Fecha (DD/MM/YYYY)")
    plt.ylabel("Humedad (%)")
    plt.grid(True)
    plt.show()

def graficar_dispersion(datos):
    """
    Muestra un grÃ¡fico de dispersiÃ³n entre temperatura y presiÃ³n.
    """
    temperaturas = [d["temperatura"] for d in datos]
    presiones = [d["presion"] for d in datos]

    plt.clear_figure()
    plt.title("ğŸ§­ PresiÃ³n vs Temperatura")
    plt.scatter(temperaturas, presiones)
    plt.xlabel("Temperatura (Â°C)")
    plt.ylabel("PresiÃ³n (hPa)")
    plt.grid(True)
    plt.show()

def menu_graficas(datos):
    """
    MenÃº interactivo para seleccionar y mostrar grÃ¡ficos.
    """
    while True:
        print("\nğŸ“Š Elige una opciÃ³n para visualizar:")
        print("1. GrÃ¡fico de lÃ­neas (Temperatura)")
        print("2. GrÃ¡fico de barras (Humedad)")
        print("3. Diagrama de dispersiÃ³n (PresiÃ³n vs Temperatura)")
        print("4. Ver todas")
        print("5. Salir")

        opcion = input("ğŸ‘‰ Tu elecciÃ³n: ").strip()
        if opcion == "1":
            graficar_lineas(datos)
        elif opcion == "2":
            graficar_barras(datos)
        elif opcion == "3":
            graficar_dispersion(datos)
        elif opcion == "4":
            graficar_lineas(datos)
            graficar_barras(datos)
            graficar_dispersion(datos)
        elif opcion == "5":
            break
        else:
            print("âš ï¸ OpciÃ³n invÃ¡lida. Intenta de nuevo.")

def mostrar_datos(actual, pronostico):
    """
    Imprime en consola los datos climÃ¡ticos actuales y del pronÃ³stico.

    Args:
        actual (dict): Datos actuales.
        pronostico (list): Lista de datos del pronÃ³stico.
    """
    print(f"\nğŸŒ† Clima actual en {actual['ciudad']} ({actual['fecha']}):")
    print(f"  Temperatura: {actual['temperatura']} Â°C")
    print(f"  Humedad: {actual['humedad']} %")
    print(f"  PresiÃ³n: {actual['presion']} hPa")
    print("\nğŸ“… PronÃ³stico a 5 dÃ­as (18:00 hrs):")
    for p in pronostico:
        print(f"  {p['fecha']} -> Temp: {p['temperatura']} Â°C, Humedad: {p['humedad']} %, PresiÃ³n: {p['presion']} hPa")

def main():
    """
    FunciÃ³n principal que coordina el flujo completo del programa.
    """
    ciudad = input("ğŸŒ† Ingrese la ciudad para consultar el clima: ").strip()
    if not ciudad:
        print("âŒ No ingresÃ³ ninguna ciudad.")
        return

    actual = get_weather_current(ciudad)
    if actual is None:
        return

    pronostico = get_weather_forecast(ciudad)
    mostrar_datos(actual, pronostico)

    datos_guardar = [actual] + pronostico
    guardar_csv(datos_guardar, "clima_datos.csv")
    guardar_json(datos_guardar, "clima_datos.json")
    guardar_excel(datos_guardar, "clima_datos.xlsx")

    print("\nâœ… Datos guardados en 'clima_datos.csv', 'clima_datos.json' y 'clima_datos.xlsx'")

    datos_csv = leer_datos_csv("clima_datos.csv")
    print("\n--- AnÃ¡lisis basado en CSV ---")
    analizar_datos(datos_csv)
    menu_graficas(datos_csv)

if __name__ == "__main__":
    main()